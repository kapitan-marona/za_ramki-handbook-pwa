window.Views = window.Views || {};

Views.Measurements = (() => {
  const $ = (s, root=document) => root.querySelector(s);
  const $$ = (s, root=document) => Array.from(root.querySelectorAll(s));

  function scrollToSection(id){
    const el = document.getElementById(id);
    if (!el) return;
    el.scrollIntoView({ behavior: "smooth", block: "start" });
  }

  function initEffects(root){
    // reveal animation
    const items = $$(".zr-reveal", root);
    if ("IntersectionObserver" in window) {
      const io = new IntersectionObserver((entries) => {
        entries.forEach(e => {
          if (e.isIntersecting) e.target.classList.add("is-in");
        });
      }, { threshold: 0.12 });
      items.forEach(el => io.observe(el));
    } else {
      items.forEach(el => el.classList.add("is-in"));
    }

    // active step while scrolling
    const steps = $$(".zr-step", root);
    const sections = steps
      .map(s => s.getAttribute("data-target"))
      .map(id => document.getElementById(id))
      .filter(Boolean);

    function setActiveById(id){
      steps.forEach(s => s.classList.toggle("is-active", s.getAttribute("data-target") === id));
    }

    if ("IntersectionObserver" in window) {
      const sio = new IntersectionObserver((entries) => {
        // pick the top-most visible section
        const visible = entries
          .filter(e => e.isIntersecting)
          .sort((a,b) => a.boundingClientRect.top - b.boundingClientRect.top)[0];

        if (visible?.target?.id) setActiveById(visible.target.id);
      }, { root: null, threshold: 0.35 });

      sections.forEach(sec => sio.observe(sec));
    } else {
      // fallback: activate first
      if (sections[0]?.id) setActiveById(sections[0].id);
    }

    steps.forEach(btn => {
      btn.addEventListener("click", () => {
        const id = btn.getAttribute("data-target");
        if (id) scrollToSection(id);
      });
    });
  }

  function open() {
    const panel = document.querySelector("#viewer") || document.querySelector("#panel") || document.querySelector("main");
    if (!panel) { console.warn("Measurements container not found"); return; }
panel.innerHTML = `
      <div class="zr-measure-wrap">
        <div class="zr-hero zr-reveal">
          <div class="zr-hero-top">
            <div>
              <h1 class="zr-hero-title">–û–±–º–µ—Ä –ø–æ–º–µ—â–µ–Ω–∏—è</h1>
              <div class="zr-hero-sub">–ü—Ä–µ–º–∏–∞–ª—å–Ω–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –¥–ª—è –≤—ã–µ–∑–¥–∞ ‚Äî –±—ã—Å—Ç—Ä–æ, —á—ë—Ç–∫–æ, –±–µ–∑ –ø–æ—Ç–µ—Ä—å</div>
            </div>
            <div class="zr-hero-actions">
              <button class="zr-btn" type="button" id="zrChecklistBtn">–°–∫–∞—á–∞—Ç—å —á–µ–∫-–ª–∏—Å—Ç (–æ—Ñ–ª–∞–π–Ω)</button>
              <button class="zr-btn" type="button" id="zrFaqBtn">–í–æ–ø—Ä–æ—Å—ã</button>
            </div>
          </div>
        </div>

        <div class="zr-grid">
          <aside class="zr-steps zr-reveal">
            <div class="zr-step is-active" data-target="zr_sec_01">
              <span class="zr-step-dot"></span>
              <span class="zr-step-label">01</span>
            </div>
            <div class="zr-steps-line"></div>
            <div class="zr-step" data-target="zr_sec_02">
              <span class="zr-step-dot"></span>
              <span class="zr-step-label">02</span>
            </div>
            <div class="zr-steps-line"></div>
            <div class="zr-step" data-target="zr_sec_03">
              <span class="zr-step-dot"></span>
              <span class="zr-step-label">03</span>
            </div>
          </aside>

          <main>
            <section class="zr-card zr-reveal" id="zr_sec_01">
              <div class="zr-h2">
                <div class="zr-h2-num">[ 01 ]</div>
                <div class="zr-h2-text">–ü–µ—Ä–µ–¥ –∑–∞–º–µ—Ä–æ–º</div>
              </div>
              <div class="zr-kicker">–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ = —Å–∫–æ—Ä–æ—Å—Ç—å –∏ —Ç–æ—á–Ω–æ—Å—Ç—å –Ω–∞ –æ–±—ä–µ–∫—Ç–µ.</div>

              <ul class="zr-list">
                <li>–ü–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å –ø–ª–∞–Ω –¥–ª—è –Ω–∞–Ω–µ—Å–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–æ–≤.</li>
                <li>–ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –Ω–∞ —à–∞–±–ª–æ–Ω–µ –µ—Å—Ç—å –º–µ—Å—Ç–æ –ø–æ–¥ –æ–±—â–∏–µ –≥–∞–±–∞—Ä–∏—Ç—ã –∏ –ø—Ä–∏–≤—è–∑–∫–∏.</li>
              </ul>

              <div class="zr-media" style="margin-top:12px;">
                <div class="zr-img">
                  <img src="./assets/img/measurements/plan-gabarits.png" alt="–ü–ª–∞–Ω ‚Äî –æ–±—â–∏–µ –≥–∞–±–∞—Ä–∏—Ç—ã">
                </div>
                <div class="zr-img">
                  <img src="./assets/img/measurements/plan-bindings.png" alt="–ü–ª–∞–Ω ‚Äî –ø—Ä–∏–≤—è–∑–∫–∏">
                </div>
              </div>

              <div class="zr-imp">
                <div class="zr-imp-bar"></div>
                <div>
                  <div class="zr-imp-title">–í–∞–∂–Ω–æ –Ω–µ –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å</div>
                  <ul>
                    <li><b>–û–±—â–∏–µ –≥–∞–±–∞—Ä–∏—Ç—ã –≤—Å–µ—Ö —Å—Ç–µ–Ω</b></li>
                    <li><b>–ü—Ä–∏–≤—è–∑–∫–∏ –ø–æ —Å—Ç–µ–Ω–∞–º –≤—Å–µ—Ö –æ–∫–æ–Ω –∏ –¥–≤–µ—Ä–µ–π</b></li>
                  </ul>
                </div>
              </div>
            </section>

            <section class="zr-card zr-reveal" id="zr_sec_02">
              <div class="zr-h2">
                <div class="zr-h2-num">[ 02 ]</div>
                <div class="zr-h2-text">–ó–∞–º–µ—Ä</div>
              </div>
              <div class="zr-kicker">–ì–ª–∞–≤–Ω–æ–µ ‚Äî –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å –≤—ã—Å–æ—Ç—ã –∏ —Å–æ–±—Ä–∞—Ç—å –ø–æ–ª–Ω—É—é —Ñ–æ—Ç–æ/–≤–∏–¥–µ–æ –±–∞–∑—É.</div>

              <div style="margin-top:10px; font-weight:800; letter-spacing:.3px;">–ó–∞–º–µ—Ä–∏—Ç—å –≤—ã—Å–æ—Ç—ã:</div>
              <ul class="zr-list">
                <li>–î–≤–µ—Ä–µ–π</li>
                <li>–ü–æ–¥–æ–∫–æ–Ω–Ω–∏–∫–æ–≤</li>
                <li>–û–∫–æ–Ω</li>
                <li>–°—Ç—É–ø–µ–Ω–µ–π</li>
                <li>–ö–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–π</li>
                <li>–ü–æ—Ç–æ–ª–∫–æ–≤</li>
              </ul>

              <div style="margin-top:12px; font-weight:800; letter-spacing:.3px;">–§–æ—Ç–æ/–≤–∏–¥–µ–æ —Ñ–∏–∫—Å–∞—Ü–∏—è –æ–±—ä–µ–∫—Ç–∞:</div>
              <div class="zr-media" style="margin-top:10px;">
                <div class="zr-img">
                  <img src="./assets/img/measurements/photo-example-1.png" alt="–§–æ—Ç–æ—Ñ–∏–∫—Å–∞—Ü–∏—è ‚Äî –ø—Ä–∏–º–µ—Ä 1">
                </div>
                <div class="zr-img">
                  <img src="./assets/img/measurements/photo-example-2.png" alt="–§–æ—Ç–æ—Ñ–∏–∫—Å–∞—Ü–∏—è ‚Äî –ø—Ä–∏–º–µ—Ä 2">
                </div>
              </div>

              <div class="zr-ctaRow">
                <button class="zr-btn" type="button" id="zrChecklistBtn2">–°–∫–∞—á–∞—Ç—å —á–µ–∫-–ª–∏—Å—Ç (–æ—Ñ–ª–∞–π–Ω)</button>
              </div>
            </section>

            <section class="zr-card zr-reveal" id="zr_sec_03">
              <div class="zr-h2">
                <div class="zr-h2-num">[ 03 ]</div>
                <div class="zr-h2-text">–ü–æ—Å–ª–µ –≤—ã–µ–∑–¥–∞</div>
              </div>
              <div class="zr-kicker">–°–æ–±–∏—Ä–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ —Å—Ç—Ä—É–∫—Ç—É—Ä—É –ø—Ä–æ–µ–∫—Ç–∞ ‚Äî –±–µ–∑ –ø–æ—Ç–µ—Ä—å –∏ ‚Äú–∞ –≥–¥–µ —Ñ–∞–π–ª?‚Äù.</div>

              <ol class="zr-list">
                <li>–í—ã—á–µ—Ä—Ç–∏—Ç—å –æ–±–º–µ—Ä–Ω—ã–π –ø–ª–∞–Ω.</li>
                <li>–ó–∞–≥—Ä—É–∑–∏—Ç—å –ø–∞–ø–∫—É <b>¬´–û–±–º–µ—Ä–Ω—ã–π –ø–ª–∞–Ω¬ª</b> –≤ –∏—Å—Ö–æ–¥–Ω—É—é –ø–∞–ø–∫—É –ø—Ä–æ–µ–∫—Ç–∞:
                  <ul style="margin-top:8px;">
                    <li>—Ñ–æ—Ç–æ —Ñ–∏–∫—Å–∞—Ü–∏—é</li>
                    <li>–≤–∏–¥–µ–æ —Ñ–∏–∫—Å–∞—Ü–∏—é</li>
                    <li>–∏—Å—Ö–æ–¥–Ω—ã–π —Ñ–∞–π–ª –∞—Ä—Ö–∏–≤–æ–º –≤ —Ñ–æ—Ä–º–∞—Ç–µ PLA</li>
                    <li>—Ñ–∞–π–ª PDF</li>
                  </ul>
                </li>
              </ol>

              <div class="zr-ctaRow">
                <button class="zr-btn" type="button" id="zrFaqBtn2">–í–æ–ø—Ä–æ—Å—ã</button>
              </div>
            </section>
          </main>
        </div>
      </div>
    `;

    // buttons
    const goChecklist = () => window.open("./checklist/", "_blank");
    const goFaq = () => {
      // –µ—Å–ª–∏ —É —Ç–µ–±—è –µ—Å—Ç—å/–±—É–¥–µ—Ç –æ—Ç–¥–µ–ª—å–Ω—ã–π —Ä–æ—É—Ç –Ω–∞ FAQ ‚Äî –ø–æ–¥–º–µ–Ω–∏–º —Å—é–¥–∞
      // —Å–µ–π—á–∞—Å –æ—Å—Ç–∞–≤–∏–º –º—è–≥–∫—É—é –∑–∞–≥–ª—É—à–∫—É
      alert("–†–∞–∑–¥–µ–ª ¬´–í–æ–ø—Ä–æ—Å—ã¬ª –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ üôÇ");
    };

    const b1 = $("#zrChecklistBtn", panel);
    const b2 = $("#zrChecklistBtn2", panel);
    const f1 = $("#zrFaqBtn", panel);
    const f2 = $("#zrFaqBtn2", panel);
    if (b1) b1.addEventListener("click", goChecklist);
    if (b2) b2.addEventListener("click", goChecklist);
    if (f1) f1.addEventListener("click", goFaq);
    if (f2) f2.addEventListener("click", goFaq);

    initEffects(panel);
  }

  return { open };
})();


